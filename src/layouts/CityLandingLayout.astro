---
/**
 * City Landing Page Layout
 * ========================
 * Template for /service-area/[city]/ pages
 * Shows all services available in a specific city
 * Enhanced with city-specific content for local SEO
 */

import BaseLayout from './BaseLayout.astro';
import Breadcrumbs from '@/components/seo/Breadcrumbs.astro';
import Icon from '@/components/ui/Icon.astro';
import Button from '@/components/ui/Button.astro';
import TrustBar from '@/components/sections/TrustBar.astro';
import Testimonials from '@/components/sections/Testimonials.astro';
import FAQ from '@/components/sections/FAQ.astro';
import LeadForm from '@/components/forms/LeadForm.astro';
import { services, cities, business } from '@/data/site';
import { cityContext } from '@/data/content';
import { getCanonicalUrl, getBreadcrumbSchema } from '@/utils/seo';

interface Props {
  citySlug: string;
}

const { citySlug } = Astro.props;

const city = cities.find(c => c.slug === citySlug)!;
const context = cityContext[citySlug] || null;
const availableServices = services.filter(s => city.services?.includes(s.slug as any) ?? true);

// Adjacent cities for cross-linking
const adjacentMap: Record<string, string[]> = {
  'carlsbad': ['oceanside','encinitas','san-marcos','vista'],
  'oceanside': ['carlsbad','vista','san-marcos','camp-pendleton'],
  'vista': ['oceanside','san-marcos','carlsbad'],
  'san-marcos': ['vista','carlsbad','encinitas','escondido'],
  'encinitas': ['carlsbad','solana-beach','san-marcos','rancho-santa-fe'],
  'rancho-santa-fe': ['encinitas','solana-beach','san-marcos'],
  'solana-beach': ['encinitas','rancho-santa-fe','carlsbad','del-mar'],
  'bressi-ranch': ['carlsbad','san-marcos','encinitas'],
};
const adjacentSlugs = adjacentMap[citySlug] || [];
const adjacentCities = cities.filter(c => adjacentSlugs.includes(c.slug));

// Landmarks for local entity signals
const landmarkMap: Record<string, string[]> = {
  'carlsbad': ['LEGOLAND California', 'The Flower Fields', 'Batiquitos Lagoon', 'Carlsbad Premium Outlets', 'Carlsbad Village'],
  'oceanside': ['Oceanside Pier', 'Camp Pendleton', 'Mission San Luis Rey', 'Oceanside Harbor', 'The Strand'],
  'vista': ['Moonlight Amphitheatre', 'Brengle Terrace Park', 'Guajome Regional Park', 'Rancho Buena Vista Adobe', 'Vista Village'],
  'san-marcos': ['Double Peak Park', 'Cal State San Marcos', 'Lake San Marcos', 'San Marcos Creek', 'Discovery Hills'],
  'encinitas': ['Swami\'s Beach', 'Moonlight State Beach', 'San Elijo Lagoon', 'Self-Realization Fellowship', 'Cardiff-by-the-Sea'],
  'rancho-santa-fe': ['Rancho Santa Fe Golf Club', 'The Inn at Rancho Santa Fe', 'Fairbanks Ranch Country Club', 'Del Dios Highway', 'Lake Hodges'],
  'solana-beach': ['Fletcher Cove Beach Park', 'Cedros Avenue Design District', 'Tide Beach Park', 'San Elijo Lagoon', 'Lomas Santa Fe Plaza'],
  'bressi-ranch': ['Bressi Ranch Park', 'The Crossings at Carlsbad', 'Palomar Airport Road', 'El Camino Real Corridor'],
};
const landmarks = landmarkMap[citySlug] || [];

// SEO
const title = `Emergency Restoration Services in ${city.name}, CA | Tamarack Restoration`;
const description = `24/7 emergency water damage, fire, mold & flood restoration in ${city.name}. ${business.reviewCount} five-star reviews. 60-minute response. IICRC certified. Call ${business.phoneFormatted}.`;
const canonical = getCanonicalUrl(`/service-area/${city.slug}/`);

const breadcrumbs = [
  { label: 'Home', href: '/' },
  { label: 'Service Areas', href: '/service-area/' },
  { label: city.name, href: `/service-area/${city.slug}/`, current: true },
];
const breadcrumbSchema = getBreadcrumbSchema(breadcrumbs);

// LocalBusiness schema with area served
const schema = {
  "@context": "https://schema.org",
  "@type": "LocalBusiness",
  "name": business.name,
  "telephone": business.phoneFormatted,
  "url": canonical,
  "address": {
    "@type": "PostalAddress",
    "streetAddress": `${business.address.street} ${business.address.suite}`,
    "addressLocality": business.address.city,
    "addressRegion": business.address.state,
    "postalCode": business.address.zip
  },
  "areaServed": {
    "@type": "City",
    "name": city.name,
    "containedInPlace": { "@type": "State", "name": "California" }
  },
  "aggregateRating": {
    "@type": "AggregateRating",
    "ratingValue": business.rating,
    "reviewCount": business.reviewCount
  }
};

// Dynamic FAQs for this city
const cityFaqs = [
  {
    question: `How quickly can you respond to emergencies in ${city.name}?`,
    answer: `We guarantee 60-minute response times to ${city.name} for all emergency calls. Our team is available 24/7, including holidays. ${context?.proximityStatement || `Our Carlsbad location allows us to reach ${city.name} quickly.`}`,
  },
  {
    question: `What restoration services do you offer in ${city.name}?`,
    answer: `We provide complete restoration services in ${city.name} including water damage restoration, mold removal, fire damage restoration, flood cleanup, sewage cleanup, and water leak repair. All services are available 24/7 for emergencies.`,
  },
  {
    question: `Do you work with insurance companies for ${city.name} claims?`,
    answer: `Yes, we work with all major insurance carriers and have extensive experience with claims in ${city.name}. We document all damage thoroughly, communicate directly with your adjuster, and help maximize your claim approval.`,
  },
  {
    question: `Are your technicians certified for work in ${city.name}?`,
    answer: `Absolutely. All our technicians are IICRC certified (Institute of Inspection, Cleaning and Restoration Certification), the industry gold standard. We also maintain all required California licenses and insurance.`,
  },
  {
    question: `What areas of ${city.name} do you serve?`,
    answer: `We serve all of ${city.name}${city.neighborhoods && city.neighborhoods.length > 0 ? `, including ${city.neighborhoods.slice(0, 4).join(', ')}, and all surrounding neighborhoods` : ''}. ${city.zipCodes ? `ZIP codes: ${city.zipCodes.join(', ')}.` : ''}`,
  },
];
---

<BaseLayout 
  title={title}
  description={description}
  canonical={canonical}
  jsonLd={[schema, breadcrumbSchema]}
>
  <!-- Hero -->
  <section class="relative bg-brand-black overflow-hidden min-h-[450px] lg:min-h-[500px] flex items-center" style="background-image: url(/images/hero/truck-hero.webp); background-size: cover; background-position: center;">
    <div class="absolute inset-0 bg-gradient-to-r from-brand-black/85 via-brand-black/60 to-brand-black/40"></div>
    
    <div class="container relative py-16 lg:py-20">
      <Breadcrumbs items={breadcrumbs} variant="dark" class="mb-6" />
      
      <div class="grid lg:grid-cols-12 gap-8 lg:gap-12 items-center">
        <div class="lg:col-span-7">
          <div class="inline-flex items-center gap-2 bg-brand-orange/20 border border-brand-orange/40 text-brand-orange px-4 py-2 rounded-full text-sm font-medium mb-6">
            <span class="relative flex h-2 w-2">
              <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-brand-orange opacity-75"></span>
              <span class="relative inline-flex rounded-full h-2 w-2 bg-brand-orange"></span>
            </span>
            Serving {city.name} 24/7
          </div>
          
          <h1 class="text-4xl sm:text-5xl lg:text-6xl font-heading font-bold text-white mb-6 leading-[1.1] tracking-tight">
            Emergency Restoration Services in{' '}
            <span class="text-brand-orange">{city.name}</span>
          </h1>
          
          <p class="text-brand-cream-300 text-lg lg:text-xl mb-8 max-w-xl leading-relaxed">
            {city.description || `Fast, professional restoration services for ${city.name} homes and businesses. Water damage, fire, mold, and more—we respond in 60 minutes.`}
          </p>
          
          <div class="flex flex-wrap items-center gap-x-6 gap-y-3 text-sm">
            <div class="flex items-center gap-2 text-brand-cream-300">
              <Icon name="clock" size="sm" class="text-brand-orange" />
              <span>60-Minute Response</span>
            </div>
            <div class="flex items-center gap-2 text-brand-cream-300">
              <Icon name="star" size="sm" class="text-brand-orange" />
              <span>{business.rating} Stars ({business.reviewCount} Reviews)</span>
            </div>
            <div class="flex items-center gap-2 text-brand-cream-300">
              <Icon name="award" size="sm" class="text-brand-orange" />
              <span>IICRC Certified</span>
            </div>
          </div>
        </div>
        
        <div class="hidden lg:block lg:col-span-5">
          <LeadForm 
            variant="card"
            title={`Get Help in ${city.name}`}
            subtitle="60-minute emergency response"
            source={`city-${citySlug}`}
          />
        </div>
      </div>
    </div>
  </section>
  
  <TrustBar variant="light" />
  
  <!-- Services in This City -->
  <section class="section bg-white">
    <div class="container">
      <div class="text-center max-w-3xl mx-auto mb-12">
        <h2 class="font-heading text-3xl md:text-4xl font-bold text-brand-black mb-4">
          Restoration Services in {city.name}
        </h2>
        <p class="text-lg text-brand-gray">
          Complete emergency restoration for {city.name} homes and businesses.
        </p>
      </div>
      
      <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
        {availableServices.map((service) => (
          <a 
            href={`/service-area/${city.slug}/${service.slug}/`}
            class="group bg-white border border-brand-cream-300 rounded-xl p-6 hover:border-brand-orange hover:shadow-card transition-all"
          >
            <div class="flex items-center gap-3 mb-4">
              <div class="w-12 h-12 rounded-xl bg-brand-orange-100 text-brand-orange flex items-center justify-center group-hover:bg-brand-orange group-hover:text-white transition-colors">
                <Icon name={service.icon} size="lg" />
              </div>
              <h3 class="font-heading font-bold text-lg text-brand-black group-hover:text-brand-orange transition-colors">
                {service.name}
              </h3>
            </div>
            <p class="text-brand-gray text-sm mb-4">{service.shortDescription}</p>
            <span class="inline-flex items-center gap-1 text-brand-orange font-semibold text-sm">
              {service.name} in {city.name}
              <Icon name="arrow-right" size="sm" />
            </span>
          </a>
        ))}
      </div>
    </div>
  </section>
  
  <!-- Local Expertise Section -->
  {context && (
    <section class="section bg-brand-cream-200">
      <div class="container">
        <div class="grid lg:grid-cols-2 gap-12 items-center">
          <div>
            <div class="inline-flex items-center gap-2 bg-brand-orange-100 text-brand-orange px-4 py-2 rounded-full text-body-sm font-semibold mb-4">
              <Icon name="map-pin" size="sm" />
              Local Expertise
            </div>
            
            <h2 class="font-heading text-3xl md:text-4xl font-bold text-brand-black mb-6">
              Why {city.name} Chooses Tamarack Restoration
            </h2>
            
            <p class="text-lg text-brand-gray mb-6">
              {context.localExpertise}
            </p>
            
            <p class="text-lg text-brand-gray mb-8">
              {context.proximityStatement}
            </p>
            
            <div class="flex flex-wrap gap-4">
              <Button href={`tel:${business.phone}`} variant="primary">
                <Icon name="phone" size="sm" />
                Call {business.phoneFormatted}
              </Button>
              <Button href="/contact/" variant="outline">
                Request Free Estimate
              </Button>
            </div>
          </div>
          
          <div class="space-y-6">
            {/* Environmental Factors */}
            {context.environmentalFactors && context.environmentalFactors.length > 0 && (
              <div class="bg-white rounded-2xl p-6 shadow-soft">
                <h3 class="font-heading font-bold text-brand-black text-lg mb-4 flex items-center gap-2">
                  <Icon name="info" size="md" class="text-brand-orange" />
                  Local Factors We Understand
                </h3>
                <ul class="space-y-3">
                  {context.environmentalFactors.map((factor) => (
                    <li class="flex items-start gap-3">
                      <div class="flex-shrink-0 w-5 h-5 rounded-full bg-brand-orange-100 flex items-center justify-center mt-0.5">
                        <Icon name="check" size="sm" class="text-brand-orange" />
                      </div>
                      <span class="text-brand-gray">{factor}</span>
                    </li>
                  ))}
                </ul>
              </div>
            )}
            
            {/* Property Types */}
            {context.propertyTypes && context.propertyTypes.length > 0 && (
              <div class="bg-white rounded-2xl p-6 shadow-soft">
                <h3 class="font-heading font-bold text-brand-black text-lg mb-4 flex items-center gap-2">
                  <Icon name="home" size="md" class="text-brand-orange" />
                  {city.name} Properties We Serve
                </h3>
                <ul class="space-y-3">
                  {context.propertyTypes.map((type) => (
                    <li class="flex items-start gap-3">
                      <div class="flex-shrink-0 w-5 h-5 rounded-full bg-brand-orange-100 flex items-center justify-center mt-0.5">
                        <Icon name="check" size="sm" class="text-brand-orange" />
                      </div>
                      <span class="text-brand-gray">{type}</span>
                    </li>
                  ))}
                </ul>
              </div>
            )}
          </div>
        </div>
      </div>
    </section>
  )}
  
  <!-- Why Choose Us -->
  <section class="section bg-white">
    <div class="container">
      <div class="text-center max-w-3xl mx-auto mb-12">
        <h2 class="font-heading text-3xl md:text-4xl font-bold text-brand-black mb-4">
          Why {city.name} Trusts Tamarack Restoration
        </h2>
        <p class="text-lg text-brand-gray">
          The local choice for professional restoration services.
        </p>
      </div>
      
      <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8 max-w-5xl mx-auto">
        <div class="text-center">
          <div class="w-16 h-16 rounded-2xl bg-brand-orange-100 flex items-center justify-center mx-auto mb-4">
            <Icon name="clock" size="lg" class="text-brand-orange" />
          </div>
          <h3 class="font-heading font-bold text-brand-black text-xl mb-3">
            60-Minute Response
          </h3>
          <p class="text-brand-gray">
            We guarantee arrival within 60 minutes to any {city.name} address, 24 hours a day, 7 days a week.
          </p>
        </div>
        
        <div class="text-center">
          <div class="w-16 h-16 rounded-2xl bg-brand-orange-100 flex items-center justify-center mx-auto mb-4">
            <Icon name="award" size="lg" class="text-brand-orange" />
          </div>
          <h3 class="font-heading font-bold text-brand-black text-xl mb-3">
            IICRC Certified
          </h3>
          <p class="text-brand-gray">
            Our technicians hold the industry's highest certifications, ensuring quality work on every {city.name} project.
          </p>
        </div>
        
        <div class="text-center">
          <div class="w-16 h-16 rounded-2xl bg-brand-orange-100 flex items-center justify-center mx-auto mb-4">
            <Icon name="shield" size="lg" class="text-brand-orange" />
          </div>
          <h3 class="font-heading font-bold text-brand-black text-xl mb-3">
            Insurance Experts
          </h3>
          <p class="text-brand-gray">
            We work with all major carriers and help {city.name} homeowners navigate claims for maximum coverage.
          </p>
        </div>
        
        <div class="text-center">
          <div class="w-16 h-16 rounded-2xl bg-brand-orange-100 flex items-center justify-center mx-auto mb-4">
            <Icon name="map-pin" size="lg" class="text-brand-orange" />
          </div>
          <h3 class="font-heading font-bold text-brand-black text-xl mb-3">
            Locally Owned
          </h3>
          <p class="text-brand-gray">
            Based in Carlsbad, we're your neighbors. We know {city.name} and are invested in our community.
          </p>
        </div>
        
        <div class="text-center">
          <div class="w-16 h-16 rounded-2xl bg-brand-orange-100 flex items-center justify-center mx-auto mb-4">
            <Icon name="star" size="lg" class="text-brand-orange" />
          </div>
          <h3 class="font-heading font-bold text-brand-black text-xl mb-3">
            {business.reviewCount}+ 5-Star Reviews
          </h3>
          <p class="text-brand-gray">
            {city.name} families trust us with their homes. Our reviews speak to our commitment to quality.
          </p>
        </div>
        
        <div class="text-center">
          <div class="w-16 h-16 rounded-2xl bg-brand-orange-100 flex items-center justify-center mx-auto mb-4">
            <Icon name="tool" size="lg" class="text-brand-orange" />
          </div>
          <h3 class="font-heading font-bold text-brand-black text-xl mb-3">
            Complete Service
          </h3>
          <p class="text-brand-gray">
            From emergency response to final repairs, we handle everything. One company, one point of contact.
          </p>
        </div>
      </div>
    </div>
  </section>
  
  <!-- Neighborhoods, ZIP Codes & Landmarks -->
  {city.neighborhoods && city.neighborhoods.length > 0 && (
    <section class="section bg-brand-cream-200">
      <div class="container">
        <div class="text-center max-w-3xl mx-auto mb-10">
          <h2 class="font-heading text-3xl md:text-4xl font-bold text-brand-black mb-4">
            Serving All {city.name} Neighborhoods
          </h2>
          <p class="text-lg text-brand-gray">
            Fast response to every part of {city.name} — we know the roads, the neighborhoods, and the unique restoration challenges.
          </p>
        </div>

        <div class="flex flex-wrap justify-center gap-3 max-w-4xl mx-auto">
          {city.neighborhoods.map((neighborhood) => (
            <span class="px-4 py-2 bg-white rounded-full text-brand-gray text-sm font-medium shadow-soft">
              {neighborhood}
            </span>
          ))}
        </div>

        <div class="grid md:grid-cols-2 gap-6 max-w-3xl mx-auto mt-10">
          {city.zipCodes && city.zipCodes.length > 0 && (
            <div class="bg-white rounded-xl p-6 shadow-soft">
              <h3 class="font-heading font-bold text-brand-black mb-3 flex items-center gap-2">
                <Icon name="map-pin" size="sm" class="text-brand-orange" />
                ZIP Codes We Serve
              </h3>
              <div class="flex flex-wrap gap-2">
                {city.zipCodes.map((zip) => (
                  <span class="bg-brand-cream-200 px-3 py-1 rounded-full text-sm font-medium text-brand-black">
                    {zip}
                  </span>
                ))}
              </div>
            </div>
          )}

          {landmarks.length > 0 && (
            <div class="bg-white rounded-xl p-6 shadow-soft">
              <h3 class="font-heading font-bold text-brand-black mb-3 flex items-center gap-2">
                <Icon name="star" size="sm" class="text-brand-orange" />
                Landmarks Near Our Service Area
              </h3>
              <div class="flex flex-wrap gap-2">
                {landmarks.map((lm) => (
                  <span class="bg-brand-cream-200 px-3 py-1 rounded-full text-sm text-brand-gray">
                    {lm}
                  </span>
                ))}
              </div>
            </div>
          )}
        </div>
      </div>
    </section>
  )}

  <!-- Nearby Service Areas -->
  {adjacentCities.length > 0 && (
    <section class="section bg-white">
      <div class="container">
        <div class="text-center max-w-3xl mx-auto mb-10">
          <h2 class="font-heading text-3xl md:text-4xl font-bold text-brand-black mb-4">
            We Also Serve Cities Near {city.name}
          </h2>
          <p class="text-lg text-brand-gray">
            Our 60-minute response extends to all communities surrounding {city.name}.
          </p>
        </div>

        <div class="grid sm:grid-cols-2 lg:grid-cols-4 gap-4 max-w-4xl mx-auto">
          {adjacentCities.map((adj) => (
            <a
              href={`/service-area/${adj.slug}/`}
              class="group flex items-center gap-3 p-4 bg-brand-cream-200 rounded-lg hover:bg-brand-orange hover:text-white transition-colors"
            >
              <Icon name="map-pin" size="sm" class="text-brand-orange group-hover:text-white flex-shrink-0" />
              <span class="font-heading font-semibold text-brand-black group-hover:text-white">
                {adj.name}
              </span>
              <Icon name="arrow-right" size="sm" class="ml-auto text-brand-gray group-hover:text-white" />
            </a>
          ))}
        </div>
      </div>
    </section>
  )}

  <Testimonials limit={3} class="bg-brand-cream-200" />
  
  <FAQ 
    title={`${city.name} Restoration FAQs`}
    subtitle="Common questions from our customers"
    faqs={cityFaqs}
    showViewAll={false}
    class="bg-brand-cream-200"
  />
  
  <!-- Mobile Form -->
  <section class="section lg:hidden bg-white">
    <div class="container">
      <LeadForm 
        variant="card"
        title={`Get Help in ${city.name}`}
        subtitle="60-minute emergency response"
        source={`city-${citySlug}-mobile`}
      />
    </div>
  </section>
</BaseLayout>
