---
/**
 * BaseLayout Component
 * ====================
 * Main layout wrapper for all pages
 */

import '@/styles/global.css';
import SEOHead from '@/components/seo/SEOHead.astro';
import Header from '@/components/global/Header.astro';
import Footer from '@/components/global/Footer.astro';
import FloatingCTA from '@/components/global/FloatingCTA.astro';
import type { SEOProps } from '@/types';
import { getLocalBusinessSchema } from '@/utils/seo';

interface Props extends SEOProps {
  class?: string;
  preloadImage?: string;
}

const {
  title,
  description,
  canonical,
  noindex = false,
  nofollow = false,
  ogType = 'website',
  ogImage,
  twitterCard = 'summary_large_image',
  jsonLd,
  class: className,
  preloadImage = '/images/hero/truck-hero.webp',
} = Astro.props;

// Always include LocalBusiness schema
const baseSchema = getLocalBusinessSchema();
const allSchemas = jsonLd 
  ? [baseSchema, ...(Array.isArray(jsonLd) ? jsonLd : [jsonLd])]
  : [baseSchema];

const ga4MeasurementId = import.meta.env.PUBLIC_GA4_MEASUREMENT_ID?.trim() || 'G-XZ2JSQZ99Y';
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <!-- LCP image preload -->
    <link rel="preload" as="image" href={preloadImage} type="image/webp" />
    <!-- Logo preload (above fold on every page) -->
    <link rel="preload" as="image" href="/images/logo/tamarack-logo.webp" type="image/webp" />

    <!-- Preconnect to external resources -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    
    <!-- Fonts -->
    <link 
      href="https://fonts.googleapis.com/css2?family=Archivo+Black&family=Archivo:wght@400;500;600;700&family=Source+Sans+3:wght@400;500;600;700&display=swap" 
      rel="stylesheet"
    />
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="manifest" href="/site.webmanifest" />
    

    {ga4MeasurementId && (
      <>
        <script async src={`https://www.googletagmanager.com/gtag/js?id=${ga4MeasurementId}`}></script>
        <script is:inline>
          {`window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
window.gtag = gtag;
gtag('js', new Date());
gtag('config', '${ga4MeasurementId}', { send_page_view: true });`}
        </script>
      </>
    )}

    {ga4MeasurementId && (
      <script is:inline>
        {`document.addEventListener('click', function (event) {
  const link = event.target && event.target.closest ? event.target.closest('a[href^="tel:"]') : null;
  if (!link || typeof window.gtag !== 'function') return;
  const href = link.getAttribute('href') || '';
  const phoneNumber = href.replace('tel:', '');
  window.gtag('event', 'click_to_call', {
    phone_number: phoneNumber,
    link_url: href,
    page_path: window.location.pathname,
  });
});`}
      </script>
    )}

    <!-- SEO -->
    <SEOHead
      title={title}
      description={description}
      canonical={canonical}
      noindex={noindex}
      nofollow={nofollow}
      ogType={ogType}
      ogImage={ogImage}
      twitterCard={twitterCard}
      jsonLd={allSchemas}
    />
    
    <!-- Generator -->
    <meta name="generator" content={Astro.generator} />
  </head>
  
  <body class:list={['min-h-screen flex flex-col', className]}>
    <!-- Skip Link for Accessibility -->
    <a href="#main-content" class="skip-link">
      Skip to main content
    </a>
    
    <!-- Header -->
    <Header />
    
    <!-- Main Content -->
    <main id="main-content" class="flex-1">
      <slot />
    </main>
    
    <!-- Footer -->
    <Footer />
    
    <!-- Mobile Floating CTA (appears on scroll) -->
    <FloatingCTA />
  </body>
</html>
