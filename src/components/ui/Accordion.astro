---
/**
 * Accordion Component
 * ===================
 * Expandable content sections for FAQs and collapsible content
 */

import Icon from './Icon.astro';

interface AccordionItem {
  title: string;
  content: string;
  open?: boolean;
}

interface Props {
  items: AccordionItem[];
  class?: string;
  allowMultiple?: boolean;
}

const { items, class: className, allowMultiple = false } = Astro.props;
const accordionId = `accordion-${Math.random().toString(36).substring(2, 11)}`;
---

<div 
  class:list={[
    'accordion rounded-xl border border-brand-cream-300 overflow-hidden bg-white shadow-soft',
    className
  ]}
  data-accordion
  data-allow-multiple={allowMultiple}
>
  {items.map((item, index) => (
    <div 
      class:list={[
        'accordion-item',
        index !== items.length - 1 && 'border-b border-brand-cream-300'
      ]} 
      data-accordion-item
    >
      <h3 class="m-0">
        <button
          type="button"
          class="accordion-trigger w-full flex items-center justify-between gap-4 px-6 py-5 text-left transition-colors duration-150 font-heading font-semibold text-brand-black text-lg hover:bg-brand-cream-100 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-inset focus-visible:ring-brand-orange"
          aria-expanded={item.open ? 'true' : 'false'}
          aria-controls={`${accordionId}-panel-${index}`}
          id={`${accordionId}-trigger-${index}`}
          data-accordion-trigger
        >
          <span class="flex-1 pr-2">{item.title}</span>
          <span class="accordion-icon-wrapper flex-shrink-0 w-6 h-6 flex items-center justify-center rounded-full bg-brand-cream-200">
            <Icon 
              name="chevron-down" 
              size="sm" 
              class="accordion-icon text-brand-gray transition-transform duration-200" 
            />
          </span>
        </button>
      </h3>
      <div
        id={`${accordionId}-panel-${index}`}
        role="region"
        aria-labelledby={`${accordionId}-trigger-${index}`}
        class="accordion-panel"
        data-accordion-panel
        hidden={!item.open}
      >
        <div class="px-6 pb-5 text-brand-gray text-base leading-relaxed">
          <Fragment set:html={item.content} />
        </div>
      </div>
    </div>
  ))}
</div>

<script>
  function initAccordions() {
    const accordions = document.querySelectorAll('[data-accordion]');
    
    accordions.forEach((accordion) => {
      const allowMultiple = accordion.getAttribute('data-allow-multiple') === 'true';
      const triggers = accordion.querySelectorAll('[data-accordion-trigger]');
      
      triggers.forEach((trigger) => {
        trigger.addEventListener('click', () => {
          const item = trigger.closest('[data-accordion-item]');
          const panel = item?.querySelector('[data-accordion-panel]') as HTMLElement | null;
          const isExpanded = trigger.getAttribute('aria-expanded') === 'true';
          
          if (!allowMultiple && !isExpanded) {
            const otherTriggers = accordion.querySelectorAll('[data-accordion-trigger]');
            otherTriggers.forEach((otherTrigger) => {
              if (otherTrigger !== trigger) {
                otherTrigger.setAttribute('aria-expanded', 'false');
                const otherItem = otherTrigger.closest('[data-accordion-item]');
                const otherPanel = otherItem?.querySelector('[data-accordion-panel]') as HTMLElement | null;
                if (otherPanel) {
                  otherPanel.hidden = true;
                }
                otherTrigger.querySelector('.accordion-icon')?.classList.remove('rotate-180');
              }
            });
          }
          
          trigger.setAttribute('aria-expanded', isExpanded ? 'false' : 'true');
          if (panel) {
            panel.hidden = isExpanded;
          }
          
          const icon = trigger.querySelector('.accordion-icon');
          if (isExpanded) {
            icon?.classList.remove('rotate-180');
          } else {
            icon?.classList.add('rotate-180');
          }
        });
      });
    });
  }
  
  initAccordions();
  document.addEventListener('astro:page-load', initAccordions);
</script>

<style>
  .accordion-icon {
    transition: transform 0.2s ease;
  }
  
  [aria-expanded="true"] .accordion-icon {
    transform: rotate(180deg);
  }
  
  [aria-expanded="true"] .accordion-icon-wrapper {
    background-color: rgb(238 237 233);
  }
</style>
