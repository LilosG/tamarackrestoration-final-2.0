---
/**
 * ServiceAreas Section Component
 * ==============================
 * Display service area cities with Google Maps
 */

import Icon from '@/components/ui/Icon.astro';
import Button from '@/components/ui/Button.astro';
import { cities, business } from '@/data/site';

interface Props {
  class?: string;
  title?: string;
  subtitle?: string;
  variant?: 'default' | 'compact' | 'grid';
  showMap?: boolean;
  limit?: number;
}

const {
  class: className,
  title = 'Proudly Serving North San Diego County',
  subtitle = 'From our Carlsbad headquarters, we provide fast emergency response throughout the region. Our local presence means we can be on-site quickly when you need us most.',
  variant = 'default',
  showMap = true,
  limit,
} = Astro.props;

const displayCities = limit ? cities.slice(0, limit) : cities;

// Group cities by tier for visual hierarchy
const tier1Cities = displayCities.filter(c => c.tier === 1);
const tier2Cities = displayCities.filter(c => c.tier === 2);
const tier3Cities = displayCities.filter(c => c.tier === 3);

// Prepare city data for map
const mapCities = displayCities.map(city => ({
  name: city.name,
  lat: city.coordinates.latitude,
  lng: city.coordinates.longitude,
  tier: city.tier,
  slug: city.slug,
}));

const hqCoords = {
  lat: business.coordinates.latitude,
  lng: business.coordinates.longitude,
};

const GOOGLE_MAPS_API_KEY = 'AIzaSyC4_tV4_ZyxWxAktce0tyx7l5F1KSGpWxg';
---

<section class:list={['service-areas section', className]}>
  <div class="container">
    {variant === 'grid' ? (
      <!-- Grid variant - just the cities -->
      <div class="text-center max-w-3xl mx-auto mb-10">
        <h2 class="font-display text-display-lg text-brand-black mb-4">{title}</h2>
        <p class="text-body-lg text-brand-gray">{subtitle}</p>
      </div>
      
      <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
        {displayCities.map((city) => (
          <a 
            href={`/service-area/${city.slug}/`}
            class="group flex items-center gap-3 p-4 bg-white rounded-xl border border-brand-cream-300 hover:border-brand-orange hover:shadow-card transition-all"
          >
            <Icon name="map-pin" size="md" class="text-brand-orange flex-shrink-0" />
            <span class="font-medium text-brand-black group-hover:text-brand-orange transition-colors">
              {city.name}
            </span>
          </a>
        ))}
      </div>
    ) : (
      <!-- Default variant with map -->
      <div class="grid lg:grid-cols-2 gap-12 items-center">
        <!-- Content Side -->
        <div>
          <div class="inline-flex items-center gap-2 bg-brand-orange-100 text-brand-orange px-4 py-2 rounded-full text-body-sm font-semibold mb-4">
            <Icon name="map-pin" size="sm" />
            Local Service
          </div>
          
          <h2 class="font-display text-display-lg text-brand-black mb-4">
            {title}
          </h2>
          
          <p class="text-body-lg text-brand-gray mb-8">
            {subtitle}
          </p>
          
          <!-- City List by Tier -->
          <div class="space-y-6 mb-8">
            {tier1Cities.length > 0 && (
              <div>
                <h3 class="text-body-sm font-semibold text-brand-orange uppercase tracking-wider mb-3">
                  Primary Service Area
                </h3>
                <div class="grid grid-cols-2 gap-3">
                  {tier1Cities.map((city) => (
                    <a 
                      href={`/service-area/${city.slug}/`}
                      class="flex items-center gap-2 text-brand-black hover:text-brand-orange transition-colors font-medium"
                    >
                      <Icon name="check-circle" size="sm" class="text-brand-orange" />
                      {city.name}
                    </a>
                  ))}
                </div>
              </div>
            )}
            
            {tier2Cities.length > 0 && (
              <div>
                <h3 class="text-body-sm font-semibold text-brand-gray-600 uppercase tracking-wider mb-3">
                  Extended Service Area
                </h3>
                <div class="grid grid-cols-2 gap-3">
                  {tier2Cities.map((city) => (
                    <a 
                      href={`/service-area/${city.slug}/`}
                      class="flex items-center gap-2 text-brand-black hover:text-brand-orange transition-colors font-medium"
                    >
                      <Icon name="map-pin" size="sm" class="text-brand-orange" />
                      {city.name}
                    </a>
                  ))}
                </div>
              </div>
            )}
            
            {tier3Cities.length > 0 && (
              <div class="grid grid-cols-2 gap-3">
                {tier3Cities.map((city) => (
                  <a 
                    href={`/service-area/${city.slug}/`}
                    class="flex items-center gap-2 text-brand-black hover:text-brand-orange transition-colors font-medium"
                  >
                    <Icon name="map-pin" size="sm" class="text-brand-gray" />
                    {city.name}
                  </a>
                ))}
              </div>
            )}
          </div>
          
          <div class="flex flex-wrap gap-4">
            <Button href="/service-area/" variant="primary">
              View All Service Areas
            </Button>
            <Button href={`tel:${business.phone}`} variant="outline">
              <Icon name="phone" size="sm" />
              Call for Service
            </Button>
          </div>
        </div>
        
        <!-- Map Side -->
        {showMap && (
          <div class="relative">
            <div class="aspect-square rounded-2xl overflow-hidden shadow-card relative">
              <!-- Google Map Container -->
              <div id="service-area-map" class="w-full h-full"></div>
              
              <!-- Response time badge overlay -->
              <div class="absolute bottom-4 left-4 right-4 bg-white/95 backdrop-blur-sm rounded-xl p-4 shadow-card z-10">
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-brand-orange-100 flex items-center justify-center">
                      <Icon name="lightning" size="md" class="text-brand-orange" />
                    </div>
                    <div>
                      <p class="font-semibold text-brand-black">60-Minute Response</p>
                      <p class="text-body-sm text-brand-gray">Throughout our service area</p>
                    </div>
                  </div>
                  <div class="text-right">
                    <p class="text-body-sm text-brand-gray">Available</p>
                    <p class="font-bold text-brand-orange">24/7</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        )}
      </div>
    )}
  </div>
</section>

{showMap && (
  <script define:vars={{ mapCities, hqCoords, GOOGLE_MAPS_API_KEY }}>
    function initServiceAreaMap() {
      const mapElement = document.getElementById('service-area-map');
      if (!mapElement) return;
      
      // Custom map styles matching brand colors
      const mapStyles = [
        {
          featureType: 'all',
          elementType: 'geometry',
          stylers: [{ color: '#f5f3ef' }]
        },
        {
          featureType: 'water',
          elementType: 'geometry',
          stylers: [{ color: '#c9d6df' }]
        },
        {
          featureType: 'road',
          elementType: 'geometry',
          stylers: [{ color: '#ffffff' }]
        },
        {
          featureType: 'road',
          elementType: 'geometry.stroke',
          stylers: [{ color: '#e0ddd5' }]
        },
        {
          featureType: 'road.highway',
          elementType: 'geometry',
          stylers: [{ color: '#f5d6c6' }]
        },
        {
          featureType: 'poi',
          stylers: [{ visibility: 'off' }]
        },
        {
          featureType: 'transit',
          stylers: [{ visibility: 'off' }]
        },
        {
          featureType: 'administrative',
          elementType: 'geometry.stroke',
          stylers: [{ color: '#c9c4bc' }]
        },
        {
          featureType: 'administrative.locality',
          elementType: 'labels.text.fill',
          stylers: [{ color: '#1a1a1a' }]
        }
      ];
      
      const map = new google.maps.Map(mapElement, {
        center: hqCoords,
        zoom: 11,
        styles: mapStyles,
        disableDefaultUI: true,
        zoomControl: true,
        zoomControlOptions: {
          position: google.maps.ControlPosition.RIGHT_CENTER
        },
        mapTypeControl: false,
        streetViewControl: false,
        fullscreenControl: false,
      });
      
      // HQ Marker (orange, prominent)
      new google.maps.Marker({
        position: hqCoords,
        map: map,
        title: 'Tamarack Restoration HQ - Carlsbad',
        icon: {
          path: google.maps.SymbolPath.CIRCLE,
          scale: 12,
          fillColor: '#E85D25',
          fillOpacity: 1,
          strokeColor: '#ffffff',
          strokeWeight: 3,
        },
        zIndex: 100,
      });
      
      // Add HQ label
      new google.maps.Marker({
        position: hqCoords,
        map: map,
        icon: {
          url: 'data:image/svg+xml,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="100" height="30"><rect rx="6" width="100" height="30" fill="#E85D25"/><text x="50" y="20" text-anchor="middle" fill="white" font-family="Arial" font-weight="bold" font-size="11">Carlsbad HQ</text></svg>'),
          anchor: new google.maps.Point(50, 45),
        },
        zIndex: 101,
      });
      
      // City markers
      mapCities.forEach(city => {
        if (city.slug === 'carlsbad') return; // Skip HQ, already added
        
        const markerColor = city.tier === 1 ? '#E85D25' : city.tier === 2 ? '#666666' : '#999999';
        const scale = city.tier === 1 ? 8 : 6;
        
        new google.maps.Marker({
          position: { lat: city.lat, lng: city.lng },
          map: map,
          title: city.name,
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            scale: scale,
            fillColor: markerColor,
            fillOpacity: 0.9,
            strokeColor: '#ffffff',
            strokeWeight: 2,
          },
        });
        
        // City label
        new google.maps.Marker({
          position: { lat: city.lat, lng: city.lng },
          map: map,
          icon: {
            url: 'data:image/svg+xml,' + encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="80" height="24"><rect rx="4" width="80" height="24" fill="white" fill-opacity="0.95"/><text x="40" y="16" text-anchor="middle" fill="#1a1a1a" font-family="Arial" font-size="11">${city.name}</text></svg>`),
            anchor: new google.maps.Point(40, -5),
          },
        });
      });
    }
    
    // Load Google Maps API
    if (typeof google === 'undefined') {
      const script = document.createElement('script');
      script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&callback=initServiceAreaMap`;
      script.async = true;
      script.defer = true;
      window.initServiceAreaMap = initServiceAreaMap;
      document.head.appendChild(script);
    } else {
      initServiceAreaMap();
    }
  </script>
)}
